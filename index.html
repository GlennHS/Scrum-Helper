<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scrum Helper</title>
  <link rel="icon" 
      type="image/png" 
      href="../favicon.png">
  <link rel="stylesheet" href="./assets/fontawesome/css/all.min.css">
  <link rel="stylesheet" theme href="./assets/css/light.css">
  <link rel="stylesheet" theme href="./assets/css/dark.css">
  <link rel="stylesheet" theme href="./assets/css/spook.css">
  <link rel="stylesheet" theme href="./assets/css/accessibilityLight.css">
  <link rel="stylesheet" theme href="./assets/css/accessibilityDark.css">
  <script defer src="./assets/fontawesome/js/all.min.js"></script>
</head>

<body>
  <main>
    <h1>Scrum Helper: It Probably Worksâ„¢</h1>
    <h2 id="egg">A Daily Choose Your Own Adventure!</h2>
    <div id="shortcuts">
      <p id="quirks"><em><strong>Current Issues: </strong><a href="https://gisthub.com/GlennHS/Scrum-Helper/projects/1">Please see issues tracker for all known issues and their most recent status</a></em></p>
      <table>
        <tr>
          <td><strong>Ctrl+#</strong></td>
          <td>Add task and focus it</td>
        </tr>
        <tr>
          <td><strong>Ctrl+Del</strong></td>
          <td>Delete current task and focus previous task</td>
        </tr>
        <tr>
          <td><strong>Ctrl+Up/Down</strong></td>
          <td>Go to previous/next task</td>
        </tr>
        <tr>
          <td><strong>Tab/Shift+Tab</strong></td>
          <td>Go to next/previous input field</td>
        </tr>
        <tr>
          <td><strong>Ctrl+/</strong></td>
          <td>Swap between capacity dropdown and last task</td>
        </tr>
        <tr>
          <td><strong>Ctrl+Enter</strong></td>
          <td>Generate message and copy it to clipboard</td>
        </tr>
      </table>
      <div id="top-buttons">
        <button onclick="toggleTheme()">Change Theme</button>
      </div>
    </div>
    <div id="output">
      <strong id="msg-name"></strong>
      <br />
      <strong id="msg-date"></strong>
      <br />
      <br />
      <div id="msg-tasks">

      </div>
      <span id="msg-total-blocked"></span><br />
      <u><b><span id="msg-capacity"></span></b></u><br />
      <span id="msg-exact-capacity"></span>
    </div>

    <template id="template-msg-task">
      <strong class="task-name"></strong><br />
      <span class="task-status"></span><br />
      <span class="task-hours"></span><br class="task-hours-break"/>
      <i class="task-blocked"></i><br /><br />
    </template>

    <template id="DOM-task">
      <div class="task">
        <div class="priority priority-top"><i class="fas fa-level-up-alt"></i></div>
        <div class="priority priority-up"><i class="fas fa-long-arrow-alt-up"></i></div>
        <div class="priority priority-down"><i class="fas fa-long-arrow-alt-down"></i></div>
        <div class="priority priority-bottom"><i class="fas fa-level-down-alt"></i></div>
        <label for="taskname">Clarizen Task:</label>
        <input type="text" autofocus name="taskname" placeholder="Clarizen Task Name">
        <label for="blocked">Blocked?</label>
        <select name="blocked">
          <option value="No">No</option>
          <option value="Partial">Partial</option>
          <option value="Yes">Yes</option>
        </select>
        <label for="hours">Expected Hours:</label>
        <input type="number" name="hours">
        <label for="status">Status Update:</label>
        <input type="text" name="status" placeholder="Status Update">
        <input type="button" name="delete" value="Delete Task">
      </div>
    </template>
    <div id="pre-task-details">
      <label for="username">Your Name: </label>
      <input type="text" name="username" placeholder="Dan Brown">
    </div>
    <div id="task-holder"></div>
    <br />
    <form id="main-controls">
      <label for="capacity">Capacity:</label>
      <select id="capacity" class="Light" name="capacity">
        <option value="Light" selected>Light - &gt;3 hours available capacity // &lt;50% Full </option>
        <option value="Medium">Medium - 1-3 hours available capacity // 50-85% Full </option>
        <option value="Busy">Busy - &lt;1 hour available capacity, on-track // 85-95% Full </option>
        <option value="Full">Full - No free capacity, on-track // 100% Full </option>
        <option value="Overloaded">!Overloaded! - Can't meet current deadlines with unblocked work, off-track // &gt;100%
          Full </option>
      </select>
      <label for="exact-capacity">Utilisation % (optional): </label>
      <input name="exact-capacity" type="number" value="0">
      <input type="button" value="Add Task" name="addTask">
      <input type="button" value="Generate Message" name="generateMsg">
    </form>
    <br />
    <div id="cute-container">
      <img id="cute" src="https://cataas.com/cat/cute" style="width: 200px; height: 200px;object-fit: cover;"/>
    </div>
    <textarea tabindex="-1" id="fallback"></textarea>
  </main>

  <!--#region Widgets-->
  <widgets>
    <div id="fixed-sidenav">

      <div class="sidenav-module hidden" module-name="settings">
        <form onsubmit="location.reload()">
          <label for="setting-lightThemeTeams">Using Light Theme Teams<input type="checkbox" name="setting-lightThemeTeams"></input></label>
          <label for="setting-lightThemeTeams">Disable Auto-Capacity<input type="checkbox" name="setting-lightThemeTeams"></input></label>
          <input type="submit" value="Update Settings"></input>
        </form>
      </div>

      <div class="sidenav-module hidden" module-name="highlow">
        <span id="high-header">Highs</span>
        <ul class="highlow-list" id="high-list">
          <li><input class="high-input" type="text" placeholder="Text Here"></input></li>
        </ul>
        <span id="low-header">Lows</span>
        <ul class="highlow-list" id="low-list">
          <li><input class="low-input" type="text" placeholder="Text Here"></input></li>
        </ul>
      </div>

      <div id="sidenav-buttons">
        <div class="sidenav-button" opens-module="settings"><i class="fas fa-cog"></i></div>
        <div class="sidenav-button" opens-module="theme"><i class="fas fa-palette"></i></div>
        <div class="sidenav-button" opens-module="todo"><i class="fas fa-tasks"></i></div>
        <div class="sidenav-button" opens-module="highlow"><i class="fas fa-sort"></i></div>
      </div>
    </div>
  </widgets>
  <!-- #endregion -->
  <script src="assets/jquery-3.6.0.min.js"></script>
  <script async defer>
    let chosenTheme = "dark", tasks = [], currentTaskNum = 0;

    // #region Utility Functions
    const copyDivToClipboard = () => {
      if (!navigator.userAgent.includes("Firefox")) {
        var range = document.createRange();
        range.selectNode(document.getElementById("output"));
        window.getSelection().removeAllRanges(); // clear current selection
        window.getSelection().addRange(range); // to select text
        document.execCommand("copy");
        window.getSelection().removeAllRanges(); // to deselect
      } else {
        console.log("Using Mozilla, fallback used")
        document.getElementById("fallback").value = document.getElementById("output").innerText
        document.getElementById("fallback").focus()
        document.getElementById("fallback").select()
        document.execCommand("copy")
      }
      document.getElementById("output").scrollIntoView({behavior: "smooth", block: "end", inline: "nearest"});
    }

    const createElementFromHTML = (htmlString) => {
      var div = document.createElement('div');
      div.innerHTML = htmlString.trim();

      return div.firstChild;
    }

    const nullCheck = (v) => { return v ? v : "" }

    const capacityPrettify = () => { $("#capacity")[0].classList = $("#capacity").val(); }

    const changeFocus = (movinOnUp) => {
      const $currDiv = $("input:focus").parent(".task");
      if(movinOnUp) {
        try {
          $currDiv.prev(".task").find("input[name='taskname']").focus()
        } catch {}
      } else {
        try {
          $currDiv.next(".task").find("input[name='taskname']").focus()
        } catch {}
      }
    }
    // #endregion

    // #region Storage Get/Set
    const setStorage = () => {
      try {
        let storageJSON = {
          "tasklist": [],
          "capacity": "Low",
          "exactCapacity": "",
          "subreddits": [],
          "theme": "pastel",
          "username": "",
          "todo": "",
          "highsLows": ""
        }
        storageJSON.tasklist = tasks
        storageJSON.capacity = $("#capacity").val()
        storageJSON.exactCapacity = $('input[name="exact-capacity"]').val()
        storageJSON.username = $('input[name="username"]').val()
        storageJSON.theme = chosenTheme
        storageJSON.todo = $("#todoWidget textarea").val()
        storageJSON.highsLows = $("#highsLowsWidget textarea").val()

        localStorage.setItem("tasklistV2", JSON.stringify(storageJSON))
      } catch(e) { console.log(e); }
    }

    const getStorage = () => {
      try {
        let storedJSON = JSON.parse(localStorage.getItem("tasklistV2"))
        let capacityVal = storedJSON.capacity
        if(nullCheck(storedJSON.exactCapacity) != "" && storedJSON.exactCapacity != 0) {
          $('input[name="exact-capacity"]').val(storedJSON.exactCapacity)
        }
        if(tasks.length === 0) {
          tasks = storedJSON.tasklist
        }
        currentTaskNum = Math.max(...(tasks.map(t=>t.id)))
        updateDOMFromTasks()
        $("#todoWidget textarea").val(storedJSON.todo)
        $("#highsLowsWidget textarea").val(storedJSON.highsLows)
        $("#capacity").val(storedJSON.capacity)
        capacityPrettify()
        if(storedJSON.username != undefined) {
          document.querySelector('input[name="username"]').value = storedJSON.username
        }
        chosenTheme = storedJSON.theme;
        setTheme();
      } catch(e) { console.log(e); }
    }
    // #endregion

    // #region Task Functions
    const generateNewTask = () => {
      currentTaskNum++
      return {
        id: currentTaskNum,
        name: "",
        status: "",
        hours: 0,
        blocked: "No"
      }
    }

    const addTask = () => {
      const newTask = generateNewTask()
      tasks.push(newTask)
      addTaskToDOM(newTask)
    }

    const deleteTask = (taskID) => {
      tasks = tasks.filter(t => t.id != taskID)
      deleteTaskFromDOM(taskID)
    }

    const deleteTaskShortcut = () => {
      const $focussedTaskElem = $("input:focus").parent(".task")
      const taskID = $focussedTaskElem.attr("taskid")
      $focussedTaskElem.prev().find("input[name='taskname']").focus()
      deleteTask(taskID)
    }

    const addTaskToDOM = (task) => {
      const taskElem = $("#DOM-task")[0].content.cloneNode(true)
      let $taskElem = $(taskElem)
      
      $taskElem.find(".task").attr("taskid", task.id)
      $taskElem.find(".task").attr("id",`task-${task.id}`)
      $taskElem.find(".priority-top").attr("onclick", `moveTaskTopPriority(${task.id})`)
      $taskElem.find(".priority-up").attr("onclick", `moveTaskUpPriority(${task.id})`)
      $taskElem.find(".priority-down").attr("onclick", `moveTaskDownPriority(${task.id})`)
      $taskElem.find(".priority-bottom").attr("onclick", `moveTaskBottomPriority(${task.id})`)
      $taskElem.find("input[name='taskname']").attr("value", task.name)
      $taskElem.find(`select[name='blocked']`).val(task.blocked)
      $taskElem.find(`input[name='hours']`).attr("value", task.hours)
      $taskElem.find("input[name='delete']").attr("onclick", `deleteTask(${task.id})`)
      
      $("#task-holder").append($taskElem)
      $(taskElem).find("input[name='taskname']").focus()
    }

    const deleteTaskFromDOM = (taskID) => {
      $("#task-holder .task").remove(`.task[taskid='${taskID}']`)
      updateTasksFromDOM()
    }

    const updateTasksFromDOM = () => {
      tasks = []
      $("#task-holder .task").each( (i, e) => {
        const $taskElem = $(e)
        tasks.push({
          id: $taskElem.attr("taskid"),
          name: $taskElem.find("input[name='taskname']").val(),
          status: $taskElem.find("input[name='status']").val(),
          hours: $taskElem.find("input[name='hours']").val(),
          blocked: $taskElem.find("select[name='blocked']").val()
        })
      })
    }

    const updateDOMFromTasks = () => {
      $('#task-holder').empty()
      tasks.forEach( t => addTaskToDOM(t))
    }

    // #region Task Priority Changers
    const moveTaskTopPriority = (taskID) => {
      // swap task with one above in tasks
      const indexOfTask = tasks.indexOf(tasks.find(t => t.id == taskID))
      const temp = tasks[indexOfTask]
      tasks.splice(indexOfTask, 1)
      tasks.unshift(temp)
      updateDOMFromTasks()
    }

    const moveTaskUpPriority = (taskID) => {
      // swap task with one above in tasks
      const indexOfTask = tasks.indexOf(tasks.find(t => t.id == taskID))
      if(tasks[indexOfTask - 1]) {
        const temp = tasks[indexOfTask - 1]
        tasks[indexOfTask - 1] = tasks[indexOfTask]
        tasks[indexOfTask] = temp
        updateDOMFromTasks()
      }
    }

    const moveTaskDownPriority = (taskID) => {
      // swap task with one above in tasks
      const indexOfTask = tasks.indexOf(tasks.find(t => t.id == taskID))
      if(tasks[indexOfTask + 1]) {
        const temp = tasks[indexOfTask + 1]
        tasks[indexOfTask + 1] = tasks[indexOfTask]
        tasks[indexOfTask] = temp
        updateDOMFromTasks()
      }
    }

    const moveTaskBottomPriority = (taskID) => {
      // swap task with one above in tasks
      const indexOfTask = tasks.indexOf(tasks.find(t => t.id == taskID))
      const temp = tasks[indexOfTask]
      tasks.splice(indexOfTask, 1)
      tasks.push(temp)
      updateDOMFromTasks()
    }
    // #endregion
    // #endregion

    // #region Event Listeners
    const ctrlShortcuts = {
      "Delete": deleteTaskShortcut,
      "#": addTask,
      "ArrowUp": () => changeFocus(true),
      "ArrowDown": () => changeFocus(false),
      "/": function() {
        if($("#capacity")[0] === document.activeElement) {
          $("#task-holder .task:last-child input[name='taskname']").focus()
        } else {
          $("#capacity").focus();
        }
      },
      "Enter": function() {
        generateMsg();
        setTimeout(copyDivToClipboard, 500)
      },
    };

    $('#task-holder').on('focusout', "input", () => {
      $("input").on('focusout', updateTasksFromDOM)
      $("select").on('focusout', updateTasksFromDOM)
      $('input[name="hours"]').on('focusout', () => {
        // get all hours elems' values
        let totHours = 0
        $('input[name="hours"]').each( (i, e) => {
          const $e = $(e)
          if($e.val()) {
            totHours += parseFloat($e.val())
          }
        })
        // Add them and divide by 0.075 to get util%
        // If Friday then actually 0.07 (FML)
        let utilPercentage = 0;
        if((new Date()).getDay() === 5) {
          utilPercentage = Math.round(totHours / 0.07)
        } else {
          utilPercentage = Math.round(totHours / 0.075)
        }

        $('input[name="exact-capacity"]').val(utilPercentage)

        let capacityName;
        if(utilPercentage <= 50) { capacityName = "Light"}
        else if(utilPercentage <= 85) { capacityName = "Medium"}
        else if(utilPercentage <= 95) { capacityName = "Busy"}
        else if(utilPercentage <= 100) { capacityName = "Full"}
        else { capacityName = "Overloaded"}

        $(`#capacity`).val(capacityName)
      })
    })

    $("#capacity").change(capacityPrettify)

    document.addEventListener('keydown', (e) => {
      // If ctrl key is active, look up a function to run
      // in ctrlShortcuts depending on the key pressed.
      if (e.ctrlKey && ctrlShortcuts[e.key]) {
        const functionToRun = ctrlShortcuts[e.key];
        functionToRun();
      }
    });

    $("input[name='addTask']").click(addTask)

    $("input[name='generateMsg']").click(() => {
      generateMsg();
      document.getElementById("output").scrollIntoView({behavior: "smooth", block: "end", inline: "nearest"});
    })

    $('h1').click( () => {
      const vaguelyAmusing = [
        "Now with 20% less sodium!",
        "No animals were harmed in the making of this site!",
        "It Probably Worksâ„¢",
        "Private Header: Do Not Read",
        "Clinically proven to cure bad breath!",
        "Now it only breaks SOME of the time!",
        "ORBS ORBS ORBS ORBS",
        "You're Our Millionth Customer!",
        "Please click gently, it's delicate...",
        "Now completely vegan!",
        "Built with <3... mostly.",
        "How do you keep an idiot in suspense?",
        "'Firefox annoys me' edition.",
        "Now proudly NOT supporting IE.",
        "Haven't you got work to be doing?",
        "Want to see something amazing? Look in a mirror :)",
        "Check me out @ https://github.com/GlennHS !",
        "Caches are like hugs. Best when warm <3",
        "Now sponsored by absolutely no one!",
        "If it ain't broke, Seabrook's not touched it yet",
        "Now with theming, you're welcome Seabrook",
        `Proudly remembering Dan B for ${Math.floor((Date.now() - Date.parse("2021-09-30")) / 86400000)} days`
      ]
      document.getElementById("egg").innerText = `(${vaguelyAmusing[Math.floor(Math.random() * vaguelyAmusing.length)]})`
    })
    // #endregion

    // #region Theming
    const themes = []
    $("link[theme]").each((i, e) => {
      const $e = $(e)
      const href = $e.attr("href")
      themes.push(new RegExp("css\/([a-z\-]+)", "gi").exec(href)[1])
    });

    const toggleTheme = () => {
      chosenTheme = themes[(themes.indexOf(chosenTheme) + 1) % themes.length];
      setTheme()
    }

    const setTheme = () => {
      Array.from(document.querySelectorAll("link[theme]")).forEach(e => e.disabled = true)
      document.querySelector(`link[href*='/${chosenTheme}.css']`).disabled = false;
    }
    // #endregion

    // #region Widgets
    $('.sidenav-button').click( function() {
      const module = $(this).attr("opens-module")
      const $targetedModule = $(`.sidenav-module[module-name="${module}"`)
      if($targetedModule.hasClass("hidden")) {
        $(".sidenav-module").addClass("hidden")
        $targetedModule.removeClass("hidden")
      } else { $targetedModule.addClass("hidden") }
    })
    
    $(".highlow-list").on("input", "li", function() {
      const $list = $(this).parent(".highlow-list")
      if($(this).find("input").val().length > 0) {
        if($list.children("li").last().find("input").val().length > 0) {
          let type = "low"
          if($list.attr('id') === "high-list") {
            type = "high"
          }
          $(`#${type}-list`).append(
            createElementFromHTML(`<li><input class="${type}-input" type="text" placeholder="Text Here"></input></li>`)
          )
        }
      } else {
        if($list.children("li").length > 1) {
          $list.children("li").last().remove();
        }
      }
    })
    // #endregion

    const generateMsg = () => {
      let numBlocked = 0,
        $outElem = $("#output"),
        name = $('input[name="username"]').val().trim(),
        capacity = $("#capacity").val(),
        exactCapacity = $('input[name="exact-capacity"]').val() || 0

      // Future me, ko-KR means YYYY/MM/DD, not that someone's pranking you by messing with your datestamp
      if(name !== "") {
        $("#msg-name").text(name)
        $("#msg-date").text(new Date().toLocaleDateString('ko-KR'))
      }

      $("#msg-tasks").empty()

      tasks.forEach(task => {
        if(!(task.blocked === "No")) { numBlocked++; }

        let clone = $("#template-msg-task")[0].content.cloneNode(true)
        let $taskElem = $(clone)
        $taskElem.find(".task-name").text(`Name: ${task.name}`)
        $taskElem.find(".task-status").text(`Status: ${task.status}`)
        $taskElem.find(".task-blocked").text(`Blocked: ${task.blocked}`)
        if(task.hours > 0) {
          $taskElem.find(".task-hours").text(`Expected Hours Today: ${task.hours}`)
        } else {
          $taskElem.find(".task-hours, .task-hours-break").remove()
        }
        $("#msg-tasks").append($taskElem)
      })
      $('#msg-total-blocked').text(`Number of Tasks Blocked: ${numBlocked}`)
      $('#msg-capacity').text(`Available Capacity: ${$("#capacity").val()}`)
      $('#msg-exact-capacity').text("")
      if(exactCapacity && exactCapacity != 0) {
        $('#msg-exact-capacity').text(`Exact Utilisation: ${$("input[name='exact-capacity']").val()}%`)
      }

      let capacityEmoji;
      if(capacity == "Light") { capacityEmoji = "âœ‹" }
      else if(capacity == "Full") { capacityEmoji = "ðŸ’¯" }
      $('#msg-capacity').append(capacityEmoji)

      if($("#capacity").val() == "Overloaded") {
        $("#msg-capacity").text(`âš âš âš    ${$("#msg-capacity").text()}   âš âš âš `)
      }

      setStorage()
      copyDivToClipboard()
    }

    const legacyTasklistHandling = () => {
      try {
        let storedJSON = JSON.parse(localStorage.getItem("tasklistV2"))
        if(typeof storedJSON.theme == "boolean") {
          chosenTheme = storedJSON.theme ? "light" : "dark"
        }
        if (storedJSON.tasklist.includes(null)) {
          tasks.push(generateNewTask())
        } else {
          storedJSON.tasklist.forEach(t => {
            if(typeof t.hours === "undefined") {
              tasks.push({
                "id": currentTaskNum,
                "name": t.name,
                "status": t.status,
                "blocked": t.blocked,
                "hours": 0
              })
              currentTaskNum++
            }
          })
        }
      } catch {}
    }

    // #region Onload/Unload
    document.onload = async function() {
      legacyTasklistHandling()
      setTheme();
      getStorage();
      if(tasks.length === 0) { addTask() }
    }()

    window.addEventListener("beforeunload", function(e){
      setStorage()
    });
    // #endregion
  </script>
</body>

</html>